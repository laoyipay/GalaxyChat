
<!-- End Wayback Rewrite JS Include -->
<style>
    * {
        text-align: center;
    }

    body {
        background: #12151c;
        color: #efb70a;
    }

    .align {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        margin-top: 200px;
    }

    .align div {
        display: inline-block;
    }

    h1 {
        font-weight: normal;
        font-size: 4em;
        font-family: sans-serif; 
        font-weight: bold; 
    }

    p {
        font-size: 1.5em;
        max-width: 600px;
        font-family: sans-serif; 
        font-weight: bold; 
    }
    
    a {
        color: #efb70a;
        text-decoration: underline;
    }


    .button {
        background-color: #efb70a;  
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
    }

    .w3-input {
        padding: 8px;
        display: block;
        border: none;
        border-bottom: 1px solid #ccc;
        width: 100%;
    }

    .mainSection  {
      margin-top: 50px;
      margin-bottom: 30px;
    }

</style>
<head>
<title>Demo</title>
<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

</head>


<div class="align">
    <div>
     

        <div class="mainSection">
      
   
            
   
           <button id="connect" class="button">  Connect with Metamask</button>
   
       
      
           <!-- <input type="text" id="walletAddress" name="Wallet Address"><br>
           <button id="addFriend" class="button">add friend</button>   -->




           <p>Send Message</p>

           <p>Wallet Address</p>
      
           <input type="text" id="walletAddress" name="Wallet Address"><br>


           <p>Message</p>
           <input type="text" id="messageText" name="MessageText"><br>

           <button id="send" class="button">Send Message</button>


        

        </div>
      
        <p>  </p> 
        <p>  </p> 
        <p>  </p> 

    
    </div> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>

    
    <script>


$(function() {


  

    if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
            console.log("Metamask installed！ ",web3.currentProvider);
            
    } else {
           // set the provider you want from Web3.providers
           web3 = new Web3(new Web3.providers.HttpProvider("https://data-seed-prebsc-2-s2.binance.org:8545/"));   
           console.log("web3",web3);
    }


    web3.eth.getAccounts(console.log);
    web3.eth.getBlock(14681880).then(function(blockDetail){
        console.log("blockDetail",blockDetail);
    });
    web3.eth.getBlock(1).then(function(blockDetail){
        console.log("blockDetail",blockDetail);
    });

    web3.eth.getBlock(1651307196).then(function(blockDetail){
        console.log("blockDetail 1651307196",blockDetail);
    });
    web3.eth.getAccounts().then(console.log);

    
    
    console.log("Block Time: ",web3.eth.getBlock(1651307196).timestamp);
    var date = web3.eth.getBlock(1920050).timestamp 

    console.log("date:",date);


    web3.eth.getBlock(1651307196).then(function(times){
        console.log("times",times);
    });

    var myAddress= "";

    const ethereumButton = document.querySelector('#connect');

    ethereumButton.addEventListener('click', () => {


        // if (provider !== window.ethereum) {
        // console.error('Do you have multiple wallets installed?');
        // }

        console.log(window.ethereum);

        async function getAccount() {

            var accounts = await ethereum.request({ method: 'eth_requestAccounts' });

            var chainId = await ethereum.request({ method: 'eth_chainId' });

            console.log("Chian ID: ",chainId) // 42
            

            // if (chainId != "0x38") {
            //     alert("Please switch to BSC Mainnet in Metamask");
            //     return;
            // }


            console.log("accounts ",accounts);
            
            if (accounts != undefined && accounts.length > 0) {
                alert("You already connect with Metamask");
                myAddress = accounts[0];
            }
        }

        getAccount();

    });

    

    const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"friend_key","type":"address"},{"internalType":"string","name":"name","type":"string"}],"name":"addFriend","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"allMessages","outputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"msg","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"allMessagesString","outputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"msg","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pubkey","type":"address"}],"name":"checkUserExists","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"name","type":"string"}],"name":"createAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"myAddress","type":"address"}],"name":"getMyFriendList","outputs":[{"components":[{"internalType":"address","name":"pubkey","type":"address"},{"internalType":"string","name":"name","type":"string"}],"internalType":"struct Chat.friend[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyFriendList2","outputs":[{"components":[{"internalType":"address","name":"pubkey","type":"address"},{"internalType":"string","name":"name","type":"string"}],"internalType":"struct Chat.friend[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pubkey","type":"address"}],"name":"getUsername","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"messageCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"ownAddress","type":"address"},{"internalType":"address","name":"friend_key","type":"address"}],"name":"readMessage","outputs":[{"components":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"msg","type":"string"}],"internalType":"struct Chat.message[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"friend_key","type":"address"},{"internalType":"string","name":"_msg","type":"string"}],"name":"sendMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    //合约地址
    const address = '0x87c1FD283C5E08edBC3224e4365CC7B8b9b38747';

    const contract = new web3.eth.Contract(abi, address);

    $( "#send" ).click(function() {
        console.log('send Clicked!');

        //检查一下Metamask有没安装
        if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
        } else {
            alert("Please install MetaMask");
            console.log('MetaMask is NOT installed!');
        }

        var walletAddress = $( "#walletAddress" ).val();
        var messageText = $( "#messageText" ).val();
        
        console.log("walletAddress:",walletAddress);
        console.log("messageText:",messageText);
        
        

        contract.methods.sendMessage(walletAddress,messageText).send({
                from: accounts[0],
                gas: 470000,
                gasPrice:0
        })


    });



    //Get Messsage
    (async () => {


        //Get Messsage
        contract.methods.readMessage("0x83D341B01e86EF4e1987Be96F191d1b7F05d663E","0x1509dE665356b6ca3a909630cd4646B54D26711D").call((err, result) => { 
            console.log(" err",err) 
            console.log("result",result)
          

        });

        contract.methods.getMyFriendList().call((err, result) => { 
            console.log(" err",err) 
            console.log("getMyFriendList result",result)
          

        });


    })();


    });






    </script>